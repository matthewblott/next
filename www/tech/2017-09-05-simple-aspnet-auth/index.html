<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-77648562-1"></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="One two buckle shoe">
  <title>Simple ASP.NET Auth</title>
  <!-- <link rel="stylesheet" href="/assets/css/theme-light.css" media="(prefers-color-scheme: light)"> -->
  <!-- <link rel="stylesheet" href="/assets/css/theme-dark.css" media="(prefers-color-scheme: dark)"> -->
  <link rel="stylesheet" href="/assets/css/theme-light.css">
  
  <link rel="stylesheet" href="/assets/css/site.css">
  
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism-okaidia.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="/pagefind/pagefind-ui.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>

<body><header>
  <a href="/" class="logo">
    <span>
      CCH
    </span>
    <svg viewBox="-10 0 660 512">
      <use href="/assets/img/coffee.svg#x"></use>
    </svg>
  </a>
  <nav>
    <a href="/">Home</a>
    <a href="/about">About</a> 
    <span><a id="show-search">Click here</a> for search or press Cmd+K</span>
  </nav>
  <span>
  </span>
</header>

  <main>
    <article>
      <h1>Simple ASP.NET Auth</h1> 
      <h2>2017-09-05</h2>
      <p>.NET Core has been with us for a while now and I was someone who did a fair bit of work with it early on. I was keen to use it as MVC on Mono came with its own set of problems but I only shipped my first app to production on .NET Core fairly recently. One of the things holding me back from migrating from MVC5 was user management. I've only used the Membership model in the form of a roles based custom provider with a few overridden methods. My interfaces were something like the following.</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMembershipProvider</span>
<span class="token punctuation">{</span>
  <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ValidateUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRoleProvider</span>
<span class="token punctuation">{</span>
  <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">GetRolesForUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsUserInRole</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> rolename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And I had this working with SimpleInjector for DI with the code below.</p>
<pre class="language-csharp"><code class="language-csharp">
container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMembershipProvider<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MembershipProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UnitOfWork</span><span class="token punctuation">(</span>connStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Lifestyle<span class="token punctuation">.</span>Scoped<span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IRoleProvider<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RoleProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Lifestyle<span class="token punctuation">.</span>Scoped<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>I've seen various articles over the past few years about 'Identity' and why the old way of doing things is bad. Usually the articles cite security concerns but very few of us are writing high traffic public websites. Most development (mine included) is boring Line-of-business (LOB) CRUD apps, sometimes running on an intranet and often with a hyper vigilant network team monitoring the traffic on the production machine. I could see no compelling reason to change my user management model which though not perfect was simple to setup and secure enough for my needs. But <a href="http://ASP.NET">ASP.NET</a> Core is a complete rewrite, Membership would not be ported and the idea of having to implement Identity was an impediment to me porting existing apps to Core.</p>
<p>A few weeks ago I decided to bite the bullet and come up with a solution for moving my existing user management model across to <a href="http://ASP.NET">ASP.NET</a> Core. Heading over to the official documents seemed a good place to start but you soon become overwhelemed with the myriad of options - roles based authorisation which requires an application roles manager, a user roles manager and group role manager, claims based authorisation along with claims, claims principal and claims identity, policy based authorisation, JWT and token based authorisation, OAuth, OAuth2, Identity Server, Identity Server 4. Plus every example I came across came with the usual MS tech stack straightjacket. Don't want to use EF? How do you decouple from that? Don't want SQL Server? Where's the example of just using Sqlite? Try doing something in Rails or Django and it's a breeze by comparison (see <a href="https://sourcey.com/building-the-prefect-rails-5-api-only-app/">here</a> by way of example).</p>
<h2>KISS</h2>
<p>In the end I found out you can decouple the things you don't want (EF, SQL Server, Identity Server in my case) and knock out a really simple solution for which I've created a boilerplate <a href="https://github.com/matthewblott/simple_aspnet_auth">here</a>. The requirements for this solution were.</p>
<ul>
<li>No EF dependency (or dependency on any other ORM).</li>
<li>No database dependency.</li>
<li>Only use the main <a href="http://ASP.NET">ASP.NET</a> Core meta package.</li>
<li>No password hashing or encryption dependency (nothing is done here, you can implement whatever you want).</li>
<li>An easy to follow implementation for rules (I've tied user groups to claims and built a couple of easy to follow policies, obviously others can be added as required).</li>
<li>A token based API.</li>
</ul>
<p>Using the 80 / 20 rule I've gone for a user with user group model. I've kept the POCOs simple.</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name">IList<span class="token punctuation">&lt;</span>Group<span class="token punctuation">></span></span> Groups <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Group</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In my somewhat contrived example I have a simple IUserService with a single method to retrieve the user (and check the password).</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserService</span>
<span class="token punctuation">{</span>
  <span class="token return-type class-name">User</span> <span class="token function">GetByName</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is injected in the required controller using <a href="http://ASP.NET">ASP.NET</a> Core's built in DI.</p>
<pre class="language-csharp"><code class="language-csharp">
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IUserService<span class="token punctuation">,</span> UserService<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The <code>UserService</code> class itself creates a <code>List</code> of type <code>User</code> in the constructor, obviously in a real world situation you'd be calling some sort of database provider but I wanted to strip out those sort of dependencies to keep it simple.</p>
<p>The <code>Startup</code> class is where all the plumbing is done. I've deliberately left things out as I wanted the example to show the code related to the problem domain. The main points of interest in <code>Startup</code> are:</p>
<ul>
<li>The different authentication schemes are added for both cookie and JWT based authentication. I have to thank Shawn Wildermuth for this after reading how to do that on his site <a href="https://wildermuth.com/2017/08/19/Two-AuthorizationSchemes-in-ASP-NET-Core-2">here</a>.</li>
<li>A couple of policies are added (as referred to earlier) which should be simple to follow. One check's the logged in user is a member of the superusers group and the other that they are a member of admins.</li>
</ul>
<p>Other than that, there's not much else going on, just some simple setup stuff.</p>
<p>The <code>LoginController</code> class is where the authentication process happens with the methods for both cookie and JWT logins - Login and ApiLogin respectively.</p>
<p>The <code>ExampleController</code> is where the examples of different logins can be tested out using <a href="http://ASP.NET">ASP.NET</a>'s <code>Authorize</code> attribute. For example the following method will only return the string if the user logged in with JWT and is a member of the superusers group.</p>
<pre class="language-csharp"><code class="language-csharp">
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"~/api/superuser"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Policy <span class="token operator">=</span> GroupNames<span class="token punctuation">.</span>SuperUsers<span class="token punctuation">,</span> AuthenticationSchemes <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ApiSuperUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">"Only authenticated token based requests from superusers receive this message."</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The Github home page has a full list of the methods in <code>ExampleController</code> with explanations for each. It's very easy to get up and running, there's no migration step or setting up - you can just download the project and type <code>dotnet restore</code> followed by <code>dotnet run</code> in the console and you're away.</p>
<h2>Caveats</h2>
<p>As mentioned this is a boilerplate solution so there's lots of things missing (there's no error handling for example which you'd want to implement). I wanted to keep the code size down so you don't have to wade through <a href="http://ASP.NET">ASP.NET</a> Core 'isms' in the code, just the stuff that's relevant!</p>
<p>There's no logout implemented for JWT. I couldn't find a satisfactory way to do this using JWT itself and after doing a bit of research it wasn't clear to me that it is possible. The SPA examples I've seen save the JWT token to <code>localStorage</code> and then delete it when the user 'logs out'. This makes sense as token based authorisation is supposed to be stateless. However there is still the issue of what happens when your token expires and for this you should use a refresh token. I've not imlemented that here but there's a tutorial provided below.</p>
<h2>Further Links</h2>
<p>Implementing an API with access token and refresh token <a href="http://www.c-sharpcorner.com/article/handle-refresh-token-using-asp-net-core-2-0-and-json-web-token">here</a>.</p>
<p>As mentioned above, there's no encryption included. For a simple encryption soluton see <a href="http://mikaelkoskinen.net/post/encrypt-decrypt-string-asp-net-core">here</a>.</p>
<p>For more on hashing, encryption and randomisation in <a href="http://ASP.NET">ASP.NET</a> Core see <a href="https://www.devtrends.co.uk/blog/hashing-encryption-and-random-in-asp.net-core">here</a>.</p>
<p>And for an excellent tutorial on authorisation and authentication (and the differences between the two) in <a href="http://ASP.NET">ASP.NET</a> Core see <a href="https://andrewlock.net/introduction-to-authentication-with-asp-net-core">here</a>.</p>

    </article>
  </main><footer>
  <nav>
    <ul>
      <li><a href="">Home</a></li>
      <li><a href="">About</a></li>
    </ul>
    <ul>
      <li><a href="">Contact</a></li>
      <li><a href="">Blog</a></li>
    </ul>
    <ul>
      <li><a href="">GitHub</a></li>
      <li><a href="">Twitter</a></li>
    </ul>
  </nav>
</footer>

  <script src="/pagefind/pagefind-ui.js" defer=""></script>
  
  <script src="/assets/js/main.js"></script>
  
</body>
</html>
