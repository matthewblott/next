<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-77648562-1"></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="One two buckle shoe">
  <title>Headless Front End Testing on Linux using F# and Canopy</title>
  <!-- <link rel="stylesheet" href="/assets/css/theme-light.css" media="(prefers-color-scheme: light)"> -->
  <!-- <link rel="stylesheet" href="/assets/css/theme-dark.css" media="(prefers-color-scheme: dark)"> -->
  <link rel="stylesheet" href="/assets/css/theme-light.css">
  
  <link rel="stylesheet" href="/assets/css/site.css">
  
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism-okaidia.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="/pagefind/pagefind-ui.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>

<body><header>
  <a href="/" class="logo">
    <span>
      CCH
    </span>
    <svg viewBox="-10 0 660 512">
      <use href="/assets/img/coffee.svg#x"></use>
    </svg>
  </a>
  <nav>
    <a href="/">Home</a>
    <a href="/about">About</a> 
    <span><a id="show-search">Click here</a> for search or press Cmd+K</span>
  </nav>
  <span>
  </span>
</header>

  <main>
    <article>
      <h1>Headless Front End Testing on Linux using F# and Canopy</h1> 
      <h2>2017-01-17</h2>
      <p>I've been following F# for a while but it's only recently started appearing in my workflow for serious work. I'm not a good F# programmer at all but I'm confident enough to use it in small scripts and I think it does a pretty good job here. However, I recently discovered the front end testing framework <a href="http://lefthandedgoat.github.io/canopy/">Canopy</a> and this provides an excellent opening for anyone looking for a low level entry to the F# world.</p>
<p>In the past when I've bothered to test the front end in a .NET project I've used <a href="http://fluent.stirno.com/">FluentAutomation</a>. It's essentially a wrapper for Selenium - the same as Canopy and nearly all the front end testing frameworks - but it hasn't been updated in a long time and I always found coding in C# to test front end incredibly verbose. This is where Canopy shines, it has a really easy to use DSL that works using the query selectors anyone who's done any front end work will be familiar with.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token string">"#welcome"</span> <span class="token operator">==</span> <span class="token string">"Welcome"</span>
</code></pre>
<p>I won't go into detail as the Canopy site has some good introduction videos which contain enough to get you going but the snippet above gives you an idea of how simple it is.</p>
<p>The reason for this post is because I soon hit a problem when I wanted to automate my tests. I needed them to be headless but I was having <a href="https://github.com/lefthandedgoat/canopy/issues/320">problems</a> with the PhantomJS driver. If you follow the thread in the link you'll see I tried some workarounds but it seems like the issue is PhantomJS rather than Canopy. So it was suggested I should try running Chrome in headless mode which is what we're going to do here.</p>
<p>The first thing you'll need to do is setup your Linux server and install Mono. I've already written a brief tutorial on that <a href="/tech/2015/12/09/mono-linux-setup.html">here</a>. I suggest following the instructions on the Mono site (which I've documented) and not just following what it says on the main F# site as there are some steps missing.</p>
<p>Once that's done you'll need to install F# and nuget.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> fsharp
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> nuget
</code></pre>
<p>Then install unzip.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">unzip</span>
</code></pre>
<p>Download the Chrome driver and unzip the contents (note that this file needs to be in the root of your project).</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">wget</span> https://chromedriver.storage.googleapis.com/2.26/chromedriver_linux64.zip
<span class="token function">unzip</span> chromedriver_linux64.zip
</code></pre>
<p>Install Chrome.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">wget</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-O</span> - https://dl-ssl.google.com/linux/linux_signing_key.pub <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span> -
<span class="token function">sudo</span> <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> google-chrome-stable
</code></pre>
<p>The final install is the <code>xvfb</code> package (<a href="https://en.wikipedia.org/wiki/Xvfb">X virtual framebuffer</a>) which makes the magic happen (a big thanks goes to Chris Holt the Canopy author who gave me the information that this tutorial is based on).</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> xvfb
</code></pre>
<p>Now with everything in place we can setup a test. First install the required <code>nuget</code> packages.</p>
<pre class="language-shell"><code class="language-shell">
nuget <span class="token function">install</span> canopy <span class="token parameter variable">-excludeVersion</span> <span class="token parameter variable">-outputdirectory</span> packages
<span class="token function">rm</span> <span class="token parameter variable">-r</span> packages/Selenium.WebDriver
nuget <span class="token function">install</span> selenium.webdriver <span class="token parameter variable">-excludeVersion</span> <span class="token parameter variable">-version</span> <span class="token number">3.0</span>.0 <span class="token parameter variable">-outputdirectory</span> packages
</code></pre>
<p>You'll notice in the second line above the <code>Selenium.WebDriver</code> package is removed. This is because there is an issue with version 3.0.1 (the latest at the time of writing) and version 3.0.0 is required in order for Canopy to work (this is the version used with the CanopyStarterKit).</p>
<p>Then create a simple test file. The file will simply check the <code>h1</code> tag displays the correct text on the home page and about page of this website.</p>
<p>First create the file.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">vi</span> canopy.fsx
</code></pre>
<p>Then paste the contents below into the file and save with <code>!wq</code>.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token comment">#r "./packages/Selenium.WebDriver/lib/net40/WebDriver.dll"</span>
<span class="token comment">#r "./packages/canopy/lib/canopy.dll"</span>

<span class="token function">open</span> canopy
<span class="token function">open</span> runner

canopy.configuration.chromeDir <span class="token operator">&lt;</span>- <span class="token string">"."</span>

start chrome

<span class="token string">"Should check home page h1"</span> <span class="token operator">&amp;&amp;</span><span class="token operator">&amp;</span> fun _ -<span class="token operator">></span>
  url <span class="token string">"http://coderscoffeehouse.com/"</span>

  <span class="token string">"h1"</span> <span class="token operator">==</span> <span class="token string">"Coder's Coffee House"</span>

<span class="token string">"Should check about page h1"</span> <span class="token operator">&amp;&amp;</span><span class="token operator">&amp;</span> fun _ -<span class="token operator">></span>
  url <span class="token string">"http://coderscoffeehouse.com/about"</span>

  <span class="token string">"h1"</span> <span class="token operator">==</span> <span class="token string">"About"</span>

run<span class="token punctuation">(</span><span class="token punctuation">)</span>

quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>I was then able to run the following.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token assign-left variable"><span class="token environment constant">DISPLAY</span></span><span class="token operator">=</span>:1 xvfb-run fsharpi canopy.fsx
</code></pre>
<p>And the result was the following.</p>
<p><picture><source type="image/webp" srcset="/.11ty/image/?src=src%2Fassets%2Fimg%2Fposts%2F20170117%2F011012-sm.jpg&width=800&format=webp&via=transform 800w"><img src="/.11ty/image/?src=src%2Fassets%2Fimg%2Fposts%2F20170117%2F011012-sm.jpg&width=800&format=jpeg&via=transform" alt="" width="800" height="662"></picture></p>
<p>This is a pretty rudimentary example but it's all the information you need if you want to include headless testing in your CI build. Any comments please leave below, thanks :-)</p>

    </article>
  </main><footer>
  <nav>
    <ul>
      <li><a href="">Home</a></li>
      <li><a href="">About</a></li>
    </ul>
    <ul>
      <li><a href="">Contact</a></li>
      <li><a href="">Blog</a></li>
    </ul>
    <ul>
      <li><a href="">GitHub</a></li>
      <li><a href="">Twitter</a></li>
    </ul>
  </nav>
</footer>

  <script src="/pagefind/pagefind-ui.js" defer=""></script>
  
  <script src="/assets/js/main.js"></script>
  
</body>
</html>
