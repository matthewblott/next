<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-77648562-1"></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="One two buckle shoe">
  <title>Roll Your Own Data Access Layer</title>
  <!-- <link rel="stylesheet" href="/assets/css/theme-light.css" media="(prefers-color-scheme: light)"> -->
  <!-- <link rel="stylesheet" href="/assets/css/theme-dark.css" media="(prefers-color-scheme: dark)"> -->
  <link rel="stylesheet" href="/assets/css/theme-light.css">
  
  <link rel="stylesheet" href="/assets/css/site.css">
  
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism-okaidia.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="/pagefind/pagefind-ui.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>

<body><header>
  <a href="/" class="logo">
    <span>
      CCH
    </span>
    <svg viewBox="-10 0 660 512">
      <use href="/assets/img/coffee.svg#x"></use>
    </svg>
  </a>
  <nav>
    <a href="/">Home</a>
    <a href="/about">About</a> 
    <span><a id="show-search">Click here</a> for search or press Cmd+K</span>
  </nav>
  <span>
  </span>
</header>

  <main>
    <article>
      <h1>Roll Your Own Data Access Layer</h1> 
      <h2>2015-02-06</h2>
      <p>This is a follow up to a previous post I did about a website I'm upgrading.</p>
<p>You have a website that you manage that wasn't written by you and wasn't the best piece of software ever written to start with. But now it's old and needs upgrading. The problem is it &quot;works&quot; and rewriting it is not a priority. But badly written software often isn't modular and partial upgrading can be difficult. Babysteps are required but small steps will eventually take you a long way and the journey has to start somewhere.</p>
<p>One of the earlier tasks I like to achieve with this type of project is getting a good handle on the data layer. It's often a mixture of inline SQL and stored procedures with no consistency between how each is called - some methods just execute a concatenated string while others correctly append paramaters to a command object. But even with the correct approach you often end up with a lot of boiler plate code like the following:</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Dim</span> cnnConn <span class="token keyword">As</span> SqlConnection
<span class="token keyword">Dim</span> cmdReturn <span class="token keyword">As</span> SqlCommand
<span class="token keyword">Dim</span> intStatus <span class="token keyword">As</span> <span class="token keyword">Integer</span>
<span class="token keyword">Dim</span> strCmd <span class="token keyword">As</span> <span class="token keyword">String</span>

cnnConn <span class="token operator">=</span> <span class="token keyword">New</span> SqlConnection<span class="token punctuation">(</span><span class="token keyword">System</span>.Configuration.ConfigurationManager.ConnectionStrings<span class="token punctuation">(</span><span class="token string">"LocalSqlServer"</span><span class="token punctuation">)</span>.ConnectionString<span class="token punctuation">)</span>
cnnConn.<span class="token keyword">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

strCmd <span class="token operator">=</span> <span class="token string">"prcTemplateOrderInsert"</span>

cmdReturn <span class="token operator">=</span> <span class="token keyword">New</span> SqlCommand

<span class="token keyword">With</span> cmdReturn
  .Connection <span class="token operator">=</span> cnnConn
  .CommandText <span class="token operator">=</span> strCmd
  .CommandType <span class="token operator">=</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.CommandType.StoredProcedure
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@ID"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ID"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intID
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ID"</span><span class="token punctuation">)</span>.Direction <span class="token operator">=</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.ParameterDirection.<span class="token function">Output</span>
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@OrderType"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.TinyInt<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@OrderType"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intType
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@ClientAccountCode"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ClientAccountCode"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strClientAccountCode
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@HeadOfficeCode"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@HeadOfficeCode"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strHeadOfficeCode
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@TemplateID"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@TemplateID"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intTemplate
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@ClientStockCode"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ClientStockCode"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strClientStockCode
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@UserID"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@UserID"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intUser
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@ForUserID"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ForUserID"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intUserFor
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@OrderQty"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@OrderQty"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intQty
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@OrderValue"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Float<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@OrderValue"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> dblValue
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@FAO"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@FAO"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strFAO
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@ClientLocationCode"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ClientLocationCode"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strClientLocationCode
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@DeliveryAddress"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@DeliveryAddress"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strDelAdd
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@ClientOrderRef"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@ClientOrderRef"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strClientOrderRef
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@CostCentreCode"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@CostCentreCode"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strCostCentreCode
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@SpecialInstructions"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@SpecialInstructions"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strSpecInst
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@TextChange"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@TextChange"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> blnTextChange
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@TextChangeDetail"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.NText<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@TextChangeDetail"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strTextChange
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@Reverse"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@Reverse"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> blnReverse
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@Litho"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@Litho"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> isLitho
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@Auth"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@Auth"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> blnAuth
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@IPAdd"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.VarChar<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@IPAdd"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> strIP
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@SPStatus"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@SPStatus"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> intStatus
  .Parameters<span class="token punctuation">(</span><span class="token string">"@SPStatus"</span><span class="token punctuation">)</span>.Direction <span class="token operator">=</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.ParameterDirection.<span class="token function">Output</span>
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@NewOrder"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@NewOrder"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> blnNewOrder
  .Parameters<span class="token punctuation">(</span><span class="token string">"@NewOrder"</span><span class="token punctuation">)</span>.Direction <span class="token operator">=</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.ParameterDirection.<span class="token function">Output</span>
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@HoldOrder"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@HoldOrder"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> blnHoldOrder
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@Intervention"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.Bit<span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@Intervention"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> blnIntervention
  .Parameters.Add<span class="token punctuation">(</span><span class="token string">"@SiteID"</span><span class="token punctuation">,</span> <span class="token keyword">System</span>.<span class="token keyword">Data</span>.SqlDbType.<span class="token function">Int</span><span class="token punctuation">)</span>
  .Parameters<span class="token punctuation">(</span><span class="token string">"@SiteID"</span><span class="token punctuation">)</span>.Value <span class="token operator">=</span> SiteID
  .ExecuteNonQuery<span class="token punctuation">(</span><span class="token punctuation">)</span>
  intID <span class="token operator">=</span> .Parameters<span class="token punctuation">(</span><span class="token string">"@ID"</span><span class="token punctuation">)</span>.Value
  intStatus <span class="token operator">=</span> .Parameters<span class="token punctuation">(</span><span class="token string">"@SPStatus"</span><span class="token punctuation">)</span>.Value
  blnNewOrder <span class="token operator">=</span> .Parameters<span class="token punctuation">(</span><span class="token string">"@NewOrder"</span><span class="token punctuation">)</span>.Value

<span class="token keyword">End</span> <span class="token keyword">With</span>

cmdReturn.Dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>
cnnConn.<span class="token keyword">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
cnnConn.Dispose<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>The obvious thing to do might be to use an ORM but in here I don't want to introduce more assemblies than I already have or add another layer of abstraction.</p>
<p>So I want to bring some basic DRY principles to simple <a href="http://ADO.NET">ADO.NET</a> coding.</p>
<p>First, we'll create a generic Db class where all instances of the connection string are called from.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Class</span> Db

  <span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Function</span> GetConnection<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">As</span> SqlConnection
    <span class="token keyword">Return</span> <span class="token keyword">New</span> SqlConnection<span class="token punctuation">(</span>ConfigurationManager.ConnectionStrings<span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span>.ConnectionString<span class="token punctuation">)</span>
  <span class="token keyword">End</span> <span class="token keyword">Function</span>

<span class="token keyword">End</span> <span class="token keyword">Class</span>
</code></pre>
<p>Next we'll add a method for creating a DataSet. Nine times out of ten that's what we're doing here so it makes sense to have a generic method to handle this. Here is where the connection string is created (and ultimately destroyed).</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Function</span> GetDataSet<span class="token punctuation">(</span>sql <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">)</span> <span class="token keyword">As</span> DataSet

  <span class="token keyword">Using</span> conn <span class="token operator">=</span> Db.GetConnection<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
    <span class="token keyword">Using</span> cmd <span class="token keyword">As</span> <span class="token keyword">New</span> SqlCommand<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
      <span class="token keyword">Using</span> adapter <span class="token keyword">As</span> <span class="token keyword">New</span> SqlDataAdapter<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
      
        <span class="token keyword">Dim</span> <span class="token keyword">data</span> <span class="token keyword">As</span> <span class="token keyword">New</span> DataSet
        
        conn.<span class="token keyword">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        adapter.Fill<span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
        
        <span class="token keyword">Return</span> <span class="token keyword">data</span>
        
      <span class="token keyword">End</span> <span class="token keyword">Using</span>
      
    <span class="token keyword">End</span> <span class="token keyword">Using</span>
    
  <span class="token keyword">End</span> <span class="token keyword">Using</span>
  
<span class="token keyword">End</span> <span class="token keyword">Function</span>
</code></pre>
<p>To make the method more flexible there is an optional boolean value to indicate the sql string argument is the name of a stored procedure.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Function</span> GetDataSet<span class="token punctuation">(</span>sql <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> <span class="token keyword">Optional</span> isStoredProcedure <span class="token keyword">As</span> <span class="token keyword">Boolean</span> <span class="token operator">=</span> <span class="token keyword">False</span><span class="token punctuation">)</span> <span class="token keyword">As</span> DataSet

...

<span class="token keyword">If</span> isStoredProcedure <span class="token keyword">Then</span>
  cmd.CommandType <span class="token operator">=</span> CommandType.StoredProcedure
<span class="token keyword">End</span> <span class="token keyword">If</span>

...
</code></pre>
<p>Great now we have a generic method but it only handles a SQL string and we need to be able to append paramaters to our command object. To do this I created a method which dynamically creates paramaters by matching the names of the paramaters in the SQL source with the field names of a POCO (plain old CLR object) object using Reflection. This was a bit tricky as I had to parse the SQL for carriage returns and other problematic whitespace.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Sub</span> AddParams<span class="token punctuation">(</span><span class="token keyword">ByRef</span> cmd <span class="token keyword">As</span> SqlCommand<span class="token punctuation">,</span> source <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">)</span>

  <span class="token keyword">Dim</span> sql <span class="token operator">=</span> cmd.CommandText.ToLower<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword">For Each</span> p <span class="token keyword">In</span> source.<span class="token keyword">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>.GetProperties
  
    <span class="token keyword">Dim</span> has <span class="token keyword">As</span> Func<span class="token punctuation">(</span><span class="token keyword">Of</span> <span class="token keyword">Integer</span><span class="token punctuation">,</span> <span class="token keyword">Boolean</span><span class="token punctuation">)</span> <span class="token operator">=</span> _
      <span class="token keyword">Function</span><span class="token punctuation">(</span><span class="token function">val</span><span class="token punctuation">)</span> sql.Contains<span class="token punctuation">(</span><span class="token keyword">String</span>.Format<span class="token punctuation">(</span><span class="token string">"@{0}{1}"</span><span class="token punctuation">,</span> p.<span class="token keyword">Name</span>.ToLower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">Char</span>.ConvertFromUtf32<span class="token punctuation">(</span><span class="token function">val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">If</span> has<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">Or</span> has<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">Or</span> has<span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span> <span class="token keyword">Or</span> has<span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>
    
      <span class="token keyword">Dim</span> value <span class="token operator">=</span> p.GetValue<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
      
      cmd.Parameters.AddWithValue<span class="token punctuation">(</span><span class="token keyword">String</span>.Format<span class="token punctuation">(</span><span class="token string">"@{0}"</span><span class="token punctuation">,</span> p.<span class="token keyword">Name</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">If</span><span class="token punctuation">(</span>value <span class="token keyword">Is</span> <span class="token keyword">Nothing</span><span class="token punctuation">,</span> DBNull.Value<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
      
    <span class="token keyword">End</span> <span class="token keyword">If</span>
    
  <span class="token keyword">Next</span>
  
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
    </code></pre>
<p>We then update our <code>GetDataSet</code> method so it uses the method added above.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Function</span> GetDataSet<span class="token punctuation">(</span>sql <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> source <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> _
  <span class="token keyword">Optional</span> isStoredProcedure <span class="token keyword">As</span> <span class="token keyword">Boolean</span> <span class="token operator">=</span> <span class="token keyword">False</span><span class="token punctuation">)</span> <span class="token keyword">As</span> DataSet
      
  ...
  
  <span class="token keyword">If</span> source <span class="token keyword">IsNot</span> <span class="token keyword">Nothing</span> <span class="token keyword">Then</span>
    Db.AddParams<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> source<span class="token punctuation">)</span>
  <span class="token keyword">End</span> <span class="token keyword">If</span>
</code></pre>
<p>Most of the time I work with DataTables so we'll add a wrapper function so we don't have to extract the DataTable from the function every time.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Function</span> GetDataTable<span class="token punctuation">(</span>sql <span class="token keyword">As</span> <span class="token keyword">String</span><span class="token punctuation">,</span> source <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">,</span> _
  <span class="token keyword">Optional</span> isStoredProcedure <span class="token keyword">As</span> <span class="token keyword">Boolean</span> <span class="token operator">=</span> <span class="token keyword">False</span><span class="token punctuation">)</span> <span class="token keyword">As</span> DataTable
  
  <span class="token keyword">Return</span> Db.GetDataSet<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> source<span class="token punctuation">,</span> isStoredProcedure<span class="token punctuation">)</span>.Tables<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  
<span class="token keyword">End</span> <span class="token keyword">Function</span>
</code></pre>
<p>We're almost there. Let's create a POCO class to test our new data access methods.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Class</span> User
  <span class="token keyword">Public</span> <span class="token keyword">Property</span> Id <span class="token keyword">As</span> <span class="token keyword">Integer</span>
  <span class="token keyword">Public</span> <span class="token keyword">Property</span> <span class="token keyword">Name</span> <span class="token keyword">As</span> <span class="token keyword">String</span>
  <span class="token keyword">Public</span> <span class="token keyword">Property</span> Password <span class="token keyword">As</span> <span class="token keyword">String</span>
<span class="token keyword">End</span> <span class="token keyword">Class</span>
</code></pre>
<p>Next we'll add a method to our class that creates our SQL string and executes GetDataTable. Normally I would create a service layer but this is for demonstration purposes only.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Sub</span> [<span class="token keyword">Get</span>]<span class="token punctuation">(</span><span class="token punctuation">)</span>
  Db.GetDataTable<span class="token punctuation">(</span><span class="token operator">&lt;</span>sql<span class="token operator">></span><span class="token keyword">select</span> Id<span class="token punctuation">,</span> <span class="token keyword">Name</span><span class="token punctuation">,</span> Password from Users where Id <span class="token operator">=</span> @Id <span class="token operator">&lt;</span><span class="token operator">/</span>sql<span class="token operator">></span>.Value<span class="token punctuation">,</span> <span class="token keyword">New</span> <span class="token keyword">With</span> <span class="token punctuation">{</span>.Id <span class="token operator">=</span> <span class="token keyword">Me</span>.Id<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre>
<p>That's great but we need to bind the return values with our POCO fields. We'll create a method for doing this, again using Reflection but this time we'll match the POCO class fields with a DataRow (you'll notice the function checks for Enum fields and null values).</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Public</span> <span class="token keyword">Shared</span> <span class="token keyword">Sub</span> BindDataRow<span class="token punctuation">(</span>row <span class="token keyword">As</span> DataRow<span class="token punctuation">,</span> source <span class="token keyword">As</span> <span class="token keyword">Object</span><span class="token punctuation">)</span>
  
  <span class="token keyword">Dim</span> info <span class="token operator">=</span> source.<span class="token keyword">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>.GetProperties<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword">For Each</span> p <span class="token keyword">In</span> info
  
    <span class="token keyword">For Each</span> c <span class="token keyword">In</span> row.Table.Columns
    
      <span class="token keyword">If</span> p.<span class="token keyword">Name</span>.ToLower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> c.Caption.ToLower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>
      
        <span class="token keyword">Dim</span> value <span class="token operator">=</span> row<span class="token punctuation">(</span>c.Caption<span class="token punctuation">)</span>
        
        <span class="token keyword">If</span> p.PropertyType <span class="token operator">=</span> <span class="token keyword">GetType</span><span class="token punctuation">(</span><span class="token keyword">Boolean</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>
          value <span class="token operator">=</span> <span class="token punctuation">(</span>value.ToString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.</span>ToString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OrElse</span> value.ToString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">True</span>.ToString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">End</span> <span class="token keyword">If</span>
        
        <span class="token keyword">If</span> <span class="token keyword">Object</span>.ReferenceEquals<span class="token punctuation">(</span>p.PropertyType.BaseType<span class="token punctuation">,</span> <span class="token keyword">GetType</span><span class="token punctuation">(</span>[<span class="token keyword">Enum</span>]<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">Then</span>
          value <span class="token operator">=</span> Convert.ToInt32<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">End</span> <span class="token keyword">If</span>
        
        <span class="token keyword">If</span> <span class="token keyword">Not</span> DBNull.Value.Equals<span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token keyword">Then</span>
          p.SetValue<span class="token punctuation">(</span>source<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token keyword">End</span> <span class="token keyword">If</span>
        
      <span class="token keyword">End</span> <span class="token keyword">If</span>
      
    <span class="token keyword">Next</span>
    
  <span class="token keyword">Next</span>
  
<span class="token keyword">End</span> <span class="token keyword">Sub</span>
</code></pre>
<p>Finally we amend our POCO Get function and we're all set to go.</p>
<pre class="language-vbnet"><code class="language-vbnet">
...

<span class="token keyword">For Each</span> row <span class="token keyword">In</span> Db.GetDataTable<span class="token punctuation">(</span><span class="token string">"select Id, Name, Password from Users where Id = @Id "</span><span class="token punctuation">,</span> _
  <span class="token keyword">New</span> <span class="token keyword">With</span> <span class="token punctuation">{</span>.Id <span class="token operator">=</span> <span class="token keyword">Me</span>.Id<span class="token punctuation">}</span><span class="token punctuation">)</span>.Rows
  
  Db.BindDataRow<span class="token punctuation">(</span>row<span class="token punctuation">,</span> <span class="token keyword">Me</span><span class="token punctuation">)</span>
  
<span class="token keyword">Next</span>

...
</code></pre>
<p>That's it. If you execute the code below the Name field's value will be written to the console.</p>
<pre class="language-vbnet"><code class="language-vbnet">
<span class="token keyword">Dim</span> user <span class="token keyword">As</span> <span class="token keyword">New</span> User <span class="token keyword">With</span> <span class="token punctuation">{</span>.Id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">}</span>

user.<span class="token keyword">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

Console.WriteLine<span class="token punctuation">(</span>user.<span class="token keyword">Name</span><span class="token punctuation">)</span>
    </code></pre>
<p>There are a few things missing from this project but I've actually got a lot further with this than what is disclosed here. Certain helper methods and SQL generation for CRUD operations have been added. I will add this code to Github and the rest later. Please feel free to comment :-)</p>

    </article>
  </main><footer>
  <nav>
    <ul>
      <li><a href="">Home</a></li>
      <li><a href="">About</a></li>
    </ul>
    <ul>
      <li><a href="">Contact</a></li>
      <li><a href="">Blog</a></li>
    </ul>
    <ul>
      <li><a href="">GitHub</a></li>
      <li><a href="">Twitter</a></li>
    </ul>
  </nav>
</footer>

  <script src="/pagefind/pagefind-ui.js" defer=""></script>
  
  <script src="/assets/js/main.js"></script>
  
</body>
</html>
