<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-77648562-1"></script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="One two buckle shoe">
  <title>Simple ASP.NET Auth (Update)</title>
  <!-- <link rel="stylesheet" href="/assets/css/theme-light.css" media="(prefers-color-scheme: light)"> -->
  <!-- <link rel="stylesheet" href="/assets/css/theme-dark.css" media="(prefers-color-scheme: dark)"> -->
  <link rel="stylesheet" href="/assets/css/theme-light.css">
  
  <link rel="stylesheet" href="/assets/css/site.css">
  
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism-okaidia.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="/pagefind/pagefind-ui.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>

<body><header>
  <a href="/" class="logo">
    <span>
      CCH
    </span>
    <svg viewBox="-10 0 660 512">
      <use href="/assets/img/coffee.svg#x"></use>
    </svg>
  </a>
  <nav>
    <a href="/">Home</a>
    <a href="/about">About</a> 
    <span><a id="show-search">Click here</a> for search or press Cmd+K</span>
  </nav>
  <span>
  </span>
</header>

  <main>
    <article>
      <h1>Simple ASP.NET Auth (Update)</h1> 
      <h2>2018-07-30</h2>
      <p>A few months ago I put together a simple <a href="2017-09-05-simple-aspnet-auth">starter project</a> for <a href="http://ASP.NET">ASP.NET</a> authorisation without any dependencies or configuration setup requirements. The motivation was my frustration with the complexity of the tutorials for something that should really be quite simple. I did leave the token based authorisation only partially complete however - there was no refresh token included which was an oversight on my part. Anyhow, I've gone ahead and done this plus a few other changes.</p>
<h2>Token Based Authorisation</h2>
<p>As mentioned this will now generate a refresh token upon login. The concept is simple - when your token times out you send it along with the refresh token and receive another so you can continue with your session. I'm not going to go down into too much detail - the whole point of the project was to provide a code sample so simple it's easy to follow. There's a service <code>TokenService</code> which has three public methods <code>GenerateAccessToken</code>, <code>GenerateRefreshToken</code>, and <code>GetPrincipalFromExpiredToken</code>. The first two are fairly obvious, the last is required so we can locate our refresh token in the database. That's a minor change from the previous project - there's now a database (of sorts!). Don't worry though, it's just a text file but it's to simulate what you would do in a real world scenario - the refresh token would be saved against the logged in user.</p>
<p>There's a new <code>TokenController</code> which has two actions <code>Refresh</code> and <code>Revoke</code> which again should be fairly obvious.</p>
<h3>Putting it together</h3>
<p>It works much the same as before. To login as the <code>admin</code> user run the following in your terminal.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:5000/api/login <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token parameter variable">-d</span> <span class="token string">"Name=admin&amp;Password=password"</span>
</code></pre>
<p>This will return something similar to the following.</p>
<pre class="language-shell"><code class="language-shell"><span class="token punctuation">{</span><span class="token string">"token"</span><span class="token builtin class-name">:</span><span class="token string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjEiLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOiJhZG1pbnMiLCJuYmYiOjE1MzI5ODI5OTYsImV4cCI6MTUzMjk4MzA1NiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo1MDAwL2FwaS8iLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpLyJ9.PwL9AKuVh0yIheBG-bXMdK5X8Q1USzvE2gebYyBgVT0"</span>,<span class="token string">"refreshToken"</span><span class="token builtin class-name">:</span><span class="token string">"xmUsVDGtPpaMDqkkZqAwEv2T7n07zFwL31aYddf0WSY="</span>
</code></pre>
<p>Save both the <code>token</code> and the <code>refreshToken</code> as variables your terminal as follows as we'll need these in a bit.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token assign-left variable">TOKEN_VALUE</span><span class="token operator">=</span>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHR <span class="token punctuation">..</span>.

<span class="token assign-left variable">REFRESH_TOKEN</span><span class="token operator">=</span>xmUsVDGtPpaMDqkkZqAwEv2T7n07zFwL31aYddf0WSY<span class="token operator">=</span>
</code></pre>
<p>The <code>refreshToken</code> will be saved against the user - if you open the <code>users.json</code> file you should see something like the following.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token punctuation">{</span>
  <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
  <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"admin"</span>,
  <span class="token string">"Password"</span><span class="token builtin class-name">:</span> <span class="token string">"password"</span>,
  <span class="token string">"RefreshToken"</span><span class="token builtin class-name">:</span> <span class="token string">"xmUsVDGtPpaMDqkkZqAwEv2T7n07zFwL31aYddf0WSY="</span>,
  <span class="token string">"Groups"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"admins"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"superusers"</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
      <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"users"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>You can then run your commands as before like the following.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">curl</span> http://localhost:5000/api/admin <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Bearer <span class="token variable">$TOKEN_VALUE</span>"</span>
</code></pre>
<p>Which returns the following expected text.</p>
<pre class="language-shell"><code class="language-shell">
Only authenticated token based requests from admins receive this message
</code></pre>
<p>When this no longer works we just request a new token with the following.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:5000/api/token/refresh <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token parameter variable">-d</span> <span class="token string">"token=<span class="token variable">$TOKEN_VALUE</span>&amp;refreshToken=<span class="token variable">$REFRESH_TOKEN</span>"</span>
</code></pre>
<p>This will return json similar to that returned with the login step containing both the <code>token</code> and <code>refreshToken</code>.</p>
<p>To revoke the token at any time (if for example, when you wish to logout) run the following.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:5000/api/token/revoke <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Bearer <span class="token variable">$TOKEN_VALUE</span>"</span> <span class="token parameter variable">-H</span> <span class="token string">"Content-Length: 0"</span>
</code></pre>
<p>There's now a signup method which allows you to create a new user. Once you've done this you can login as show earlier.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://localhost:5000/api/signup <span class="token parameter variable">-H</span> <span class="token string">"Content-Type: application/x-www-form-urlencoded"</span> <span class="token parameter variable">-d</span> <span class="token string">"Name=test1&amp;Password=password"</span>
</code></pre>
<h3>Other changes</h3>
<p>I've created some example projects to keep the code size down for the different scenarios (since that was the whole point of the exercise). Below is the <code>tree</code> of the folder where they reside which is in the root of the repository.</p>
<pre class="language-shell"><code class="language-shell">
<span class="token builtin class-name">.</span>
└── examples
    ├── api
    ├── cookies
    ├── cookies+api
    └── cookies+api+policies
</code></pre>
<p>To run all the tests as shown on the home page you probably should use the <code>cookies+api</code> project. I've removed <a href="http://ASP.NET">ASP.NET</a> policies from the projects as these aren't actually necessary. You can use roles which does the same and the code base is now very small. I've kept the <code>cookies+api+policies</code> project for legacy purposes. The <code>api</code> and <code>cookies</code> projects are for when you only require one of those authentication types.</p>
<p>I should probably do some proper documentation as the home page is now slightly out of date and the repo is starting to expand a bit but I'll see what the feedback is like.</p>
<p>Here's the <a href="https://github.com/matthewblott/simple_aspnet_auth">link</a> to the code on Github.</p>
<p>Enjoy :-)</p>

    </article>
  </main><footer>
  <nav>
    <ul>
      <li><a href="">Home</a></li>
      <li><a href="">About</a></li>
    </ul>
    <ul>
      <li><a href="">Contact</a></li>
      <li><a href="">Blog</a></li>
    </ul>
    <ul>
      <li><a href="">GitHub</a></li>
      <li><a href="">Twitter</a></li>
    </ul>
  </nav>
</footer>

  <script src="/pagefind/pagefind-ui.js" defer=""></script>
  
  <script src="/assets/js/main.js"></script>
  
</body>
</html>
